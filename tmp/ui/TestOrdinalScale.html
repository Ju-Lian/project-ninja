<!DOCTYPE html>
<html>
<head>
	<title>Margin Quantity Chart</title>
	<link rel="stylesheet" type="text/css" href="../style/MarginQuantity.css">
</head>
<body>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> 
	
	<script type="text/javascript" >			
		window.onload = function()
		{ 
			//	NOTE 
			//d3.csv is an asynchronous function, therefore the csv data cannot be stored
			//into a global variable. Insert all custom functions in highlighted function.
			var csvFilePath="../data/MargeMenge.csv";
			d3.csv(csvFilePath, function(d) 
			{
				return {
					product: d.Product,
					margin: +d.Margin,
					quantity: +d.Quantity
				};
			}, 
			function(error, rows) 
			{
				//--> Insert custom function here <--
				//data is stored in rows
				//console.log(rows);
				
				var width = 500;
				var height = 200;
				var svg = d3.select("body").append("svg")
							.attr("width", width)
							.attr("height", height);	

				var obj=
				({
					svg: svg,
					width: width,
					height: height,
					name: "Margin Quantity Chart",
					padding: 40,
					rangeBandsInnerPadding: .1,
					rangeBandsOuterPadding: .6,
					sortByQuantity: true,
					data: rows
				});
				
				// ----------------------------------------------------------
				// ----------------------------------------------------------
					var chart = obj.svg.append("g").attr("id", obj.name);
					
					//Sort data
					if(obj.sortByQuantity) {
						obj.data.sort(function sortByQuantity(x,y) {
							return x.quantity-y.quantity;
						});
					}
					
					/* SCALES */
					// X
					var xMin=0;
					var xMax=function() 
					{
						var sumQuantity=0;
						for(var d in obj.data) {
							sumQuantity+=obj.data[d].quantity; //Compute sum of all quantities as xMax value
						}
						console.log(sumQuantity);
						return sumQuantity;		
					};
					var productNames = new Array(); // Product names x Axis
					for(var p in obj.data) {
						productNames.push(obj.data[p].product+":\t"+obj.data[p].quantity); //extract each product name
					}				
					var xScale = d3.scale.ordinal()
								.domain(productNames)
								.rangeRoundBands([0, width], obj.rangeBandsInnerPadding, obj.rangeBandsOuterPadding);
					// Y
					var yMin=0;
					var yMax=Math.max.apply(Math, obj.data.map(function(d){return d.margin;}));
					var yScale = d3.scale.linear()
								.domain([yMin, yMax])
								.range([obj.height - obj.padding,obj.padding]);
					
					/* AXIS */
					// X
					var xAxis = d3.svg.axis()
								.scale(xScale)
								.orient("bottom");							
					var x = chart.append("g")
						.attr("class","x axis")
						.attr("transform", "translate(0," + (obj.height - obj.padding) + ")")
						.call(xAxis)
						.selectAll("text")  // rotate text
							.style("text-anchor", "middle")
							.attr("dy", "1em")
							.attr("transform", function(d) {
								return "rotate(0)";
							});
					
					// Y
					var yAxis = d3.svg.axis()
								  .scale(yScale)
								  .orient("left")
								  .tickValues([0,(yMax)/2,yMax])
								  .tickSize(10);
					var y = chart.append("g")
							.attr("class","y axis")
							.attr("transform", "translate(" + obj.padding + ",0)")
							.call(yAxis)
							.append("text")
								.attr("class", "axis label")
								.attr("x",-obj.padding)
								.attr("y", "1em")
								.style("text-anchor", "end")
								.attr("transform", function(d) {
									return "rotate(-90)" 
								})						  
								.text("Margin");
								
					// Bars
					var quantities=obj.data.map(function(d){return d.quantity;});
					var maxQuantity=Math.max.apply(Math, quantities);
					var barWidths = new Array();
					for(var q in quantities) {
						barWidths.push((xScale.rangeBand() * quantities[q])/maxQuantity);
					}
					chart.selectAll()
						.data(obj.data.map(function(d){return d.margin;}))
						.enter().append("rect")
						.attr("class","bars")
						.attr("x", function(d,i) {
							return xScale(i)+((xScale.rangeBand()-barWidths[i])/2);
						})
						.attr("y",function(d){
							console.log("y="+yScale(d)+" d="+d);
							return yScale(d);
						})
						.attr("width", function(d,i) {
							return barWidths[i];
						})
						.attr("height", function(d){return Math.abs(yScale(0)-yScale(d));});
						
									
				// -----
			});
		}
	</script>

</body>

</html> 